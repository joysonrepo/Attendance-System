<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sunday School Attendance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 1rem;
    }
    .container { 
      max-width: 600px; 
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 1.5rem;
      text-align: center;
    }
    .header-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    h1 { 
      font-size: 1.8rem; 
      font-weight: 700;
      margin-bottom: 0.3rem;
    }
    .header-subtitle {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .content { padding: 1.5rem; }
    fieldset { 
      border: none;
      padding: 1.3rem;
      margin-bottom: 1.2rem;
      background: #f8f9ff;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    legend { 
      font-weight: 700;
      font-size: 1.05rem;
      color: #333;
      margin-bottom: 0.8rem;
    }
    label { 
      display: block; 
      margin-top: 0.8rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: #444;
    }
    input[type=text], input[type=number], select { 
      width: 100%; 
      padding: 0.75rem;
      margin-top: 0.4rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    input[type=text]:focus, input[type=number]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    select {
      cursor: pointer;
      background-color: white;
    }
    #nameSuggestions { 
      position: absolute;
      background: #fff;
      border: 2px solid #667eea;
      width: 100%;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 8px;
      margin-top: 0.3rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #nameSuggestions div { 
      padding: 0.6rem 0.8rem;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    #nameSuggestions div:hover { 
      background: #e6f0ff;
      color: #667eea;
    }
    .hidden { display: none !important; }
    .type-toggle { 
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
    }
    .type-toggle label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0;
      font-weight: 500;
      cursor: pointer;
    }
    .type-toggle input[type=radio] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .button-group {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    button { 
      flex: 1;
      min-width: 140px;
      padding: 0.9rem 1.2rem;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s;
    }
    #submitBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    #submitBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    #refreshBtn, #statsBtn, #clearBtn {
      background: #f0f0f0;
      color: #333;
      border: 2px solid #e0e0e0;
    }
    #refreshBtn:hover, #statsBtn:hover, #clearBtn:hover {
      background: #e0e0e0;
      border-color: #d0d0d0;
    }
    button:disabled { 
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status { 
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .status:empty { display: none; }
    #stats { 
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e0e0e0;
    }
    #stats h2 {
      font-size: 1.3rem;
      color: #333;
      margin-bottom: 1rem;
    }
    table { 
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td { 
      border: 1px solid #e0e0e0;
      padding: 0.8rem;
      text-align: left;
      font-size: 0.95rem;
    }
    th { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #f8f9ff;
    }
    .flex-line { 
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .pill { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      body { padding: 0.5rem; }
      .container { border-radius: 12px; }
      .header { padding: 1.5rem 1rem; }
      .header-logo { width: 70px; height: 70px; }
      h1 { font-size: 1.4rem; }
      .content { padding: 1rem; }
      .type-toggle { flex-direction: column; gap: 0.5rem; }
      .button-group { gap: 0.6rem; }
      button { min-width: 100%; }
      table { font-size: 0.85rem; }
      th, td { padding: 0.6rem 0.4rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-logo">
        <img src="kids_logo-removebg-preview.png" alt="Kids Logo" />
      </div>
      <h1>River Kids Attendance</h1>
      <p class="header-subtitle">Record and manage student attendance</p>
    </div>
    <div class="content">
      <fieldset>
        <legend>Select Group</legend>
        <div class="type-toggle">
          <label><input type="radio" name="groupSelect" value="Church" checked /> Church</label>
          <label><input type="radio" name="groupSelect" value="RFF" /> RFF</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Student Type</legend>
        <div class="type-toggle">
          <label><input type="radio" name="studentType" value="old" checked /> Existing Student</label>
          <label><input type="radio" name="studentType" value="new" /> New Student</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Student Information</legend>
        <div style="position:relative;">
          <label for="nameInput">Name</label>
          <input id="nameInput" type="text" autocomplete="off" placeholder="Start typing name..." />
          <div id="nameSuggestions" class="hidden"></div>
        </div>
        <label for="classInput">Class</label>
        <select id="classInput">
          <option value="">Select Class</option>
          <option value="KG">KG</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>
        <label for="phoneInput">Phone Number</label>
        <input id="phoneInput" type="text" placeholder="Enter phone" />
        <label for="genderInput">Gender</label>
        <select id="genderInput">
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <label for="placeInput">Place</label>
        <select id="placeSelect">
          <option value="">Select Place</option>
          <option value="MG Palaya">MG Palaya</option>
          <option value="SS Palaya">SS Palaya</option>
          <option value="Other">Other</option>
        </select>
        <input id="placeInput" type="text" placeholder="Enter custom place" class="hidden" />
      </fieldset>

      <fieldset>
        <legend>Today's Attendance</legend>
        <div class="type-toggle">
          <label><input type="radio" name="attendance" value="Present" checked /> Present</label>
          <label><input type="radio" name="attendance" value="Absent" /> Absent</label>
        </div>
      </fieldset>

      <div class="button-group">
        <button id="submitBtn" disabled>Submit Attendance</button>
        <button id="refreshBtn" type="button" title="Reload student list">Reload</button>
        <button id="statsBtn" type="button" title="Show today stats">Stats</button>
        <button id="clearBtn" type="button" title="Clear form">Clear</button>
      </div>
      <div id="status" class="status"></div>

      <div id="stats" class="hidden">
        <h2>Today's Attendance Summary</h2>
        <div id="statsSummary"></div>
        <table id="statsTable">
          <thead><tr><th>Name</th><th>Class</th><th>Group</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <fieldset style="margin-top: 1.5rem;">
        <legend>Download Report</legend>
        <label for="dateSelect">Select Date</label>
        <select id="dateSelect">
          <option value="">Select a date...</option>
        </select>
        <button id="downloadBtn" style="margin-top: 1rem; width: 100%;" disabled>Download Report</button>
      </fieldset>
    </div>
  </div>

<script>
const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbxhOUmTby4MOkVw0-WGV_BDBhxFSLod1MOoaNU05gDVWWLNiQpmtnPz35DvYlblbCeN/exec'; // No trailing slash.
/* Expected endpoints:
GET    WEB_APP_BASE + '/students' -> [{id,rowIndex,name,age,phone,gender,place}]
POST   WEB_APP_BASE + '/attendance' body: {rowIndex,date,status}
POST   WEB_APP_BASE + '/newStudent' body: {name,age,phone,gender,place,date,status}
GET    WEB_APP_BASE + '/stats?date=YYYY-MM-DD' -> {date, counts:{total,present,absent,group:{g1:{present,absent},g2:{...},g3:{...}}}, list:[{name,age,status,group}]}
*/

let students = []; // cached list
let selectedStudent = null;

const els = {
  nameInput: document.getElementById('nameInput'),
  nameSuggestions: document.getElementById('nameSuggestions'),
  classInput: document.getElementById('classInput'),
  phone: document.getElementById('phoneInput'),
  gender: document.getElementById('genderInput'),
  placeSelect: document.getElementById('placeSelect'),
  place: document.getElementById('placeInput'),
  submit: document.getElementById('submitBtn'),
  status: document.getElementById('status'),
  stats: document.getElementById('stats'),
  statsSummary: document.getElementById('statsSummary'),
  statsTableBody: document.querySelector('#statsTable tbody'),
  refresh: document.getElementById('refreshBtn'),
  statsBtn: document.getElementById('statsBtn'),
  clearBtn: document.getElementById('clearBtn'),
  dateSelect: document.getElementById('dateSelect'),
  downloadBtn: document.getElementById('downloadBtn'),
};

function todayISO() {
  return new Date().toISOString().slice(0,10);
}

function groupForClass(studentClass) {
  const c = String(studentClass).toUpperCase();
  if (c === 'KG' || c === '1' || c === '2' || c === '3') return 'Junior';
  if (c === '4' || c === '5' || c === '6') return 'Inter';
  return 'Senior';
}

function getSelectedGroup() {
  return document.querySelector('input[name=groupSelect]:checked').value;
}

async function fetchStudents() {
  const group = getSelectedGroup();
  setStatus('Loading students from ' + group + '...');
  try {
    const res = await fetch(WEB_APP_BASE + '?path=students&group=' + group);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const payload = await res.json();
    students = Array.isArray(payload) ? payload : (payload && Array.isArray(payload.list) ? payload.list : []);
    setStatus('Loaded ' + (Array.isArray(students) ? students.length : 0) + ' students.');
    enableSubmitIfReady();
  } catch (e) {
    setStatus('Failed to load students: ' + e.message, true);
  }
}

function setStatus(msg, isError=false) {
  els.status.textContent = msg;
  els.status.style.color = isError ? '#c00' : '#0a4a0a';
}

function enableSubmitIfReady() {
  const type = getStudentType();
  if (type === 'old') {
    els.submit.disabled = !selectedStudent;
  } else {
    // For new student ensure minimal fields
    const ok = els.nameInput.value.trim() && els.classInput.value.trim() && els.gender.value.trim();
    els.submit.disabled = !ok;
  }
}

function getStudentType() {
  return document.querySelector('input[name=studentType]:checked').value;
}

function clearStudentFields() {
  els.classInput.value = '';
  els.phone.value = '';
  els.gender.value = '';
  els.placeSelect.value = '';
  els.place.value = '';
  els.place.classList.add('hidden');
}

function clearForm() {
  els.nameInput.value = '';
  clearStudentFields();
  hideSuggestions();
  selectedStudent = null;
  els.submit.disabled = true;
  setStatus('');
  // Reset attendance to Present
  const presentRadio = document.querySelector('input[name=attendance][value="Present"]');
  if (presentRadio) presentRadio.checked = true;
}

function fillStudentFields(stu) {
  els.classInput.value = stu.class || '';
  els.phone.value = stu.phone || '';
  
  // Normalize gender
  const gender = (stu.gender || '').toLowerCase();
  if (gender === 'male' || gender === 'm') els.gender.value = 'Male';
  else if (gender === 'female' || gender === 'f') els.gender.value = 'Female';
  else els.gender.value = stu.gender || '';
  
  // Normalize and set place
  const place = (stu.place || '').trim();
  const placeNorm = place.toLowerCase().replace(/\s+/g, ' ');
  if (placeNorm.includes('mg') || placeNorm.includes('m g')) {
    els.placeSelect.value = 'MG Palaya';
    els.place.classList.add('hidden');
  } else if (placeNorm.includes('ss') || placeNorm.includes('s s')) {
    els.placeSelect.value = 'SS Palaya';
    els.place.classList.add('hidden');
  } else if (place) {
    els.placeSelect.value = 'Other';
    els.place.value = place;
    els.place.classList.remove('hidden');
  } else {
    els.placeSelect.value = '';
    els.place.classList.add('hidden');
  }
}

// Autocomplete logic
let suggestionHideTimer = null;
els.nameInput.addEventListener('input', () => {
  const val = els.nameInput.value.trim().toLowerCase();
  selectedStudent = null;
  if (!val || getStudentType() !== 'old') {
    hideSuggestions();
    enableSubmitIfReady();
    return;
  }
  const list = Array.isArray(students) ? students : [];
  const matches = list.filter(s => String(s.name || '').toLowerCase().includes(val)).slice(0,25);
  renderSuggestions(matches);
});

function renderSuggestions(list) {
  if (!list.length) { hideSuggestions(); return; }
  els.nameSuggestions.innerHTML = list.map(s => `<div data-id="${s.id}" data-row="${s.rowIndex}">${s.name}</div>`).join('');
  els.nameSuggestions.classList.remove('hidden');
}

function hideSuggestions() {
  els.nameSuggestions.classList.add('hidden');
  els.nameSuggestions.innerHTML = '';
}

els.nameSuggestions.addEventListener('click', e => {
  const div = e.target.closest('div[data-id]');
  if (!div) return;
  const id = div.dataset.id;
  selectedStudent = students.find(s => String(s.id) === String(id));
  if (selectedStudent) {
    els.nameInput.value = selectedStudent.name;
    fillStudentFields(selectedStudent);
    hideSuggestions();
    enableSubmitIfReady();
  }
});

// Switching between Church / RFF
Array.from(document.querySelectorAll('input[name=groupSelect]')).forEach(r => {
  r.addEventListener('change', () => {
    clearForm();
    fetchStudents();
    loadAvailableDates();
  });
});

// Switching between new / old student
Array.from(document.querySelectorAll('input[name=studentType]')).forEach(r => {
  r.addEventListener('change', () => {
    selectedStudent = null;
    if (getStudentType() === 'old') {
      clearStudentFields();
      els.submit.disabled = true;
    } else {
      clearStudentFields();
      els.submit.disabled = true;
    }
    enableSubmitIfReady();
  });
});

['classInput','phoneInput','genderInput','placeInput'].forEach(id => {
  document.getElementById(id).addEventListener('input', enableSubmitIfReady);
});

// Handle place dropdown change
els.placeSelect.addEventListener('change', () => {
  if (els.placeSelect.value === 'Other') {
    els.place.classList.remove('hidden');
    els.place.focus();
  } else {
    els.place.classList.add('hidden');
    els.place.value = '';
  }
  enableSubmitIfReady();
});

els.refresh.addEventListener('click', fetchStudents);
els.statsBtn.addEventListener('click', loadStats);
els.clearBtn.addEventListener('click', () => { clearForm(); enableSubmitIfReady(); });

async function submitAttendance() {
  const type = getStudentType();
  const attendanceStatus = document.querySelector('input[name=attendance]:checked').value;
  const group = getSelectedGroup();
  const date = todayISO();
  
  // Prevent multiple submissions
  if (els.submit.disabled) return;
  
  setStatus('‚è≥ Saving...');
  els.submit.disabled = true;
  
  let endpoint, payload;
  if (type === 'old') {
    if (!selectedStudent) { setStatus('Select a student first.', true); els.submit.disabled = false; return; }
    endpoint = '?path=attendance';
    payload = { rowIndex: selectedStudent.rowIndex, date, status: attendanceStatus, group };
  } else {
    endpoint = '?path=newStudent';
    const placeValue = els.placeSelect.value === 'Other' ? els.place.value.trim() : els.placeSelect.value;
    payload = {
      name: els.nameInput.value.trim(),
      studentClass: els.classInput.value.trim(),
      phone: els.phone.value.trim(),
      gender: els.gender.value.trim(),
      place: placeValue,
      date,
      status: attendanceStatus,
      group
    };
  }
  
  // Timeout warning after 3 seconds
  const timeoutWarning = setTimeout(() => {
    setStatus('‚è≥ Still processing... Google Sheets can be slow sometimes.');
  }, 3000);
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 sec timeout
    
    const res = await fetch(WEB_APP_BASE + endpoint, { 
      method:'POST', 
      headers:{'Content-Type':'text/plain'}, 
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    clearTimeout(timeoutWarning);
    
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    setStatus('‚úì Saved successfully!'); 
    
    // Clear form immediately for better UX
    setTimeout(() => {
      clearForm();
      setStatus('');
    }, 1000);
    
    // Reload students in background for new student
    if (type === 'new') {
      fetchStudents();
    }
  } catch (e) {
    clearTimeout(timeoutWarning);
    if (e.name === 'AbortError') {
      setStatus('‚ö† Request timed out. Please check your internet connection.', true);
    } else {
      setStatus('‚ùå Failed: ' + e.message, true);
    }
  } finally {
    els.submit.disabled = false;
  }
}

els.submit.addEventListener('click', submitAttendance);

async function loadStats() {
  const group = getSelectedGroup();
  const date = todayISO();
  setStatus('Loading stats for ' + date + ' (' + group + ')...');
  try {
    const res = await fetch(WEB_APP_BASE + '?path=stats&date=' + date + '&group=' + group);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const stats = await res.json();
    renderStats(stats);
    setStatus('Stats loaded.');
  } catch (e) {
    setStatus('Failed to load stats: ' + e.message, true);
  }
}

function renderStats(stats) {
  els.stats.classList.remove('hidden');
  const g = stats.counts.group;
  els.statsSummary.innerHTML = `
    <div class="flex-line">
      <span class="pill">Date: ${stats.date}</span>
      <span class="pill">Present: ${stats.counts.present}</span>
      <span class="pill">Absent: ${stats.counts.absent}</span>
      <span class="pill">Junior (KG-3) P:${g.junior.present} A:${g.junior.absent}</span>
      <span class="pill">Inter (4-6) P:${g.inter.present} A:${g.inter.absent}</span>
      <span class="pill">Senior (7-12) P:${g.senior.present} A:${g.senior.absent}</span>
    </div>`;
  els.statsTableBody.innerHTML = stats.list.map(s => `<tr><td>${s.name}</td><td>${s.class}</td><td>${s.group}</td><td>${s.status}</td></tr>`).join('');
}

// Initial load
fetchStudents();
loadAvailableDates();

// Load available dates for report download
async function loadAvailableDates() {
  const group = getSelectedGroup();
  try {
    const res = await fetch(WEB_APP_BASE + '?path=dates&group=' + group);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data.dates && data.dates.length > 0) {
      els.dateSelect.innerHTML = '<option value="">Select a date...</option>' + 
        data.dates.map(d => `<option value="${d}">${d}</option>`).join('');
    }
  } catch (e) {
    console.error('Failed to load dates:', e);
  }
}

// Enable download button when date is selected
els.dateSelect.addEventListener('change', () => {
  els.downloadBtn.disabled = !els.dateSelect.value;
});

// Download report
els.downloadBtn.addEventListener('click', async () => {
  const date = els.dateSelect.value;
  const group = getSelectedGroup();
  
  if (!date) {
    setStatus('Please select a date', true);
    return;
  }
  
  setStatus('Generating report...');
  els.downloadBtn.disabled = true;
  
  try {
    const res = await fetch(WEB_APP_BASE + '?path=report&date=' + date + '&group=' + group);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const report = await res.json();
    
    // Format date for display
    const dateObj = new Date(date + 'T00:00:00');
    const displayDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    
    // Filter only "Present" students and generate three-column layout
    let juniorRows = '';
    const juniorPresent = report.junior.filter(s => s.status === 'Present');
    if (juniorPresent.length === 0) {
      juniorRows = '<div style="text-align:center; color:#999; font-style:italic; padding:20px; grid-column: 1/-1;">No present students</div>';
    } else {
      juniorPresent.forEach(s => {
        juniorRows += '<div style="padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">' + s.name + '</div>';
      });
    }
    
    let interRows = '';
    const interPresent = report.inter.filter(s => s.status === 'Present');
    if (interPresent.length === 0) {
      interRows = '<div style="text-align:center; color:#999; font-style:italic; padding:20px; grid-column: 1/-1;">No present students</div>';
    } else {
      interPresent.forEach(s => {
        interRows += '<div style="padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">' + s.name + '</div>';
      });
    }
    
    let seniorRows = '';
    const seniorPresent = report.senior.filter(s => s.status === 'Present');
    if (seniorPresent.length === 0) {
      seniorRows = '<div style="text-align:center; color:#999; font-style:italic; padding:20px; grid-column: 1/-1;">No present students</div>';
    } else {
      seniorPresent.forEach(s => {
        seniorRows += '<div style="padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;">' + s.name + '</div>';
      });
    }
    
    const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Attendance Report - ' + displayDate + '</title><style>' +
      'body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; margin: 0 auto; background: #f8f9fa; }' +
      '.container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }' +
      '.logo-header { position: absolute; top: 20px; right: 20px; width: 100px; height: 100px; }' +
      '.logo-header img { width: 100%; height: 100%; object-fit: contain; }' +
      '.header-content { margin-right: 120px; }' +
      'h1 { text-align: center; color: #333; margin: 0 0 5px 0; font-size: 28px; }' +
      '.date-header { text-align: center; color: #666; margin-bottom: 30px; font-size: 18px; font-weight: bold; }' +
      'h2 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-top: 30px; margin-bottom: 15px; font-size: 20px; }' +
      '.names-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; margin-bottom: 20px; }' +
      '.name-item { padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; text-align: center; font-weight: 500; }' +
      '.name-item:hover { background: #f0f4ff; border-color: #667eea; }' +
      '@media print { body { background: white; } .container { box-shadow: none; } button { display: none; } @page { margin: 10mm; size: A4; } }' +
      '</style></head><body><div class="container">' +
      '<div class="logo-header"><img src="kids_logo-removebg-preview.png" alt="River Kids Logo" style="border-radius:8px;" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext x=%2250%22 y=%2265%22 font-size=%2240%22 text-anchor=%22middle%22%3Eüë∂%3C/text%3E%3C/svg%3E\'"></div>' +
      '<div class="header-content">' +
      '<h1>River Kids Attendance Report</h1>' +
      '<p class="date-header">Date: <strong>' + displayDate + '</strong> | Group: <strong>' + group + '</strong></p>' +
      '</div>' +
      '<h2>Junior (KG, 1, 2, 3)</h2>' +
      '<div class="names-grid">' + juniorRows.replace(/^<div/g, '<div class="name-item').split(/<\/div>/g).join('</div>') + '</div>' +
      '<h2>Inter (4, 5, 6)</h2>' +
      '<div class="names-grid">' + interRows.replace(/^<div/g, '<div class="name-item').split(/<\/div>/g).join('</div>') + '</div>' +
      '<h2>Senior (7, 8, 9, 10, 11, 12)</h2>' +
      '<div class="names-grid">' + seniorRows.replace(/^<div/g, '<div class="name-item').split(/<\/div>/g).join('</div>') + '</div>' +
      '</div>' +
      '<div style="text-align: center; margin: 20px 0;"><button onclick="window.print()" style="padding: 12px 24px; font-size: 16px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px; margin-right: 10px;">Print Report</button></div>' +
      '</body></html>';
    
    // Open report in new tab/window
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(html);
    reportWindow.document.close();
    
    setStatus('‚úì Report opened in new tab');
    els.downloadBtn.disabled = false;
  } catch (e) {
    setStatus('Failed to generate report: ' + e.message, true);
    els.downloadBtn.disabled = false;
  }
});
</script>
</body>
</html>
